{% extends "budget_base.html"%}
{% block title %}Statistics{% endblock %}

{% block content %}


    <h1 class="main-title">Hello {{user.name}}</h1>

    

<div class="expense-container">
    {% if active_expenses or inactive_expenses %}

            <!-- Chart Button Section -->
        <div class="chart-button-section">
            <form action="{{ url_for('user.charts') }}" method="POST">
                <button class="chart-button" type="submit">
                    <span class="chart-icon">ðŸ“Š</span>
                    <span class="chart-text">
                        <span class="chart-title">View Charts</span>
                        <span class="chart-desc">Visualize your budget data</span>
                    </span>
                </button>
            </form>
        </div>

        <div class="lifetime-stats-section">
            <h2 class="lifetime-stats-title">Lifetime Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card-main">
                    <div class="stat-label-main">Earnings and Deposits</div>
                    <div class="stat-value-main balance">${{lifetime_stats["Balance"]}}</div>
                </div>

                <div class="stat-card-main">
                    <div class="stat-label-main">Total Earnings</div>
                    <div class="stat-value-main earnings">${{lifetime_stats["Earnings"]}}</div>
                </div>
                
                <div class="stat-card-main">
                    <div class="stat-label-main">Deposited</div>
                    <div class="stat-value-main">${{lifetime_stats["Deposits"]}}</div>
                </div>

                <div class="stat-card-main">
                    <div class="stat-label-main">Total Spent</div>
                    <div class="stat-value-main spent">${{lifetime_stats["Spendings"]}}</div>
                </div>

                <div class="stat-card-main">
                    <div class="stat-label-main">Total Credit Balance</div>
                    <div class="stat-value-main">${{lifetime_stats["Credit_Balance"]}}</div>
                </div>

                <div class="stat-card-main">
                    <div class="stat-label-main">Total Savings</div>
                    <div class="stat-value-main savings">${{lifetime_stats["Savings"]}}</div>
                </div>

            </div>
        </div>
        {% endif %}

        {% if active_expenses %}
            <div class="expenses-section">
                <h1 class="section-title-large">Active Expenses</h1><p class="function-helper-text"><span class="tip-star">â˜…</span> Only expenses with transaction history are shown below. Create entries/deposits to view all your expenses.</p>
            {% for expense_id in active_expenses %}
            <div class="expense-block">
                <h3 class="expense-name-small">{{active_expenses[expense_id]["name"]}}</h3>
                {% set earned = active_expenses[expense_id]["earnings"]%}
                {% set spent = active_expenses[expense_id]["spending"]%}
                {% set saved = active_expenses[expense_id]["savings"]%}
                {% set balance = active_expenses[expense_id]["balance"]%}
                {% set deposit = active_expenses[expense_id]["deposits"]%}
                {% set credit_balance = active_expenses[expense_id]["credit_balance"]%}

                <table class="expense-table stats-table">
                    <thead>
                        <tr>
                            <th>Earnings and Deposits</th>
                            <th>Earned</th>
                            <th>Deposited</th>
                            <th>Spent</th>
                            <th>Credit Balance</th>
                            <th>Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="balance-cell" style="color: #a7c4ff;">${{balance}}</td>
                            <td class="earnings-cell" style="color: #5fb878;">${{earned}}</td>
                            {% if deposit %}
                                <td>${{deposit}}</td>
                            {% else %}
                                <td>$0.0</td>
                            {% endif %}
                            <td class="spent-cell" style="color: #e87373;">${{spent}}</td>
                            <td>${{credit_balance}}</td>
                            <td class="savings-cell" style="color: #5fb878;">${{saved}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endfor %}
            </div>
        {% endif %}

        {% if inactive_expenses %}
        <hr class="section-divider">
        <div class="expenses-section">
            <h1 class="section-title-large">Archived Expenses</h1>
        {% for expense_id in inactive_expenses %}
        <div class="expense-block">
            <h3 class="expense-name-small">{{inactive_expenses[expense_id]["name"]}}</h3>
            {% set earned = inactive_expenses[expense_id]["earnings"]%}
            {% set spent = inactive_expenses[expense_id]["spending"]%}
            {% set saved = inactive_expenses[expense_id]["savings"]%}
            {% set balance = inactive_expenses[expense_id]["balance"]%}
            {% set transferred = inactive_expenses[expense_id]["deposits"]%}
            {% set credit_balance = inactive_expenses[expense_id]["credit_balance"]%}

            <table class="expense-table stats-table">
                <thead>
                    <tr>
                        <th>Earnings and Deposits</th>
                        <th>Earned</th>
                        <th>Deposited</th>
                        <th>Spent</th>
                        <th>Credit Balance</th>
                        <th>Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="balance-cell">${{balance}}</td>
                        <td class="earnings-cell">${{earned}}</td>
                        <td>${{transferred}}</td>
                        <td class="spent-cell">${{spent}}</td>
                        <td>${{credit_balance}}</td>
                        <td class="savings-cell">${{saved}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endfor %}
        </div>
        {% endif %}


        {% if deposits %}
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <div class="collapsible-title-wrapper">
                    <h2 class="collapsible-title">Deposit Log</h2>
                    <span class="item-count">{{ deposits|length }} deposits</span>
                </div>
                <span class="collapsible-arrow">â–¼</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Expense</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Reasoning</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deposit in deposits %}
                            <tr>
                                <td>{{deposit.expense_name}}</td>
                                <td>{{deposit.date}}</td>
                                <td class="spent-cell">${{deposit.amount}}</td>
                                <td>{{deposit.reasoning}}</td>
                                {% if deposit.entry_id %}
                                    <td>
                                        <a href="{{url_for('entry.view_entry', entry_id = deposit.entry_id)}}" class="btn btn-success">View</a>
                                    </td>
                                {% else %}
                                    <td>
                                        <a href="{{url_for('expense.expenses')}}" class="btn btn-success">View</a>
                                    </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}


        {% if spending %}
        <hr class="section-divider">
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <div class="collapsible-title-wrapper">
                    <h2 class="collapsible-title">Spending Log</h2>
                    <span class="item-count">{{ spending|length }} expenses</span>
                </div>
                <span class="collapsible-arrow">â–¼</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Expense</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Reasoning</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spent in spending %}
                            <tr>
                                <td>{{spent.expense_name}}</td>
                                <td>{{spent.date}}</td>
                                <td class="spent-cell">${{spent.amount}}</td>
                                <td>{{spent.reasoning}}</td>
                                <td>
                                    <a href="{{url_for('entry.view_entry', entry_id = spent.entry_id)}}" class="btn btn-success">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if credits %}
        <hr class="section-divider">
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <div class="collapsible-title-wrapper">
                    <h2 class="collapsible-title">Credit Spending Log</h2>
                    <span class="item-count">{{ credits|length }} transactions</span>
                </div>
                <span class="collapsible-arrow">â–¼</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Expense</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Reasoning</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for credit in credits %}
                            <tr>
                                <td>{{credit.expense_name}}</td>
                                <td>{{credit.date}}</td>
                                <td class="spent-cell">${{credit.amount}}</td>
                                <td>{{credit.reasoning}}</td>
                                <td>
                                    <a href="{{url_for('entry.view_entry', entry_id = credit.entry_id)}}" class="btn btn-success">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not expense_data %}
        <div class="empty-state">
            <div class="empty-icon">ðŸ“Š</div>
            <h2 class="empty-title">No Entries Yet</h2>
            <p class="empty-text">You haven't created an entry yet. Create your first entry to start tracking your budget!</p>
            <a href="/entry" class="empty-cta">Create Your First Entry</a>
        </div>
        {% endif %}
    </div>
</div>
    

{% endblock %}


{% block scripts%}
<script>
function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('active');
}
</script>
{% endblock%}