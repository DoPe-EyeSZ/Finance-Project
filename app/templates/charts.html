{% extends "budget_base.html" %}
{% block title%} Charts {% endblock%}

{% block content %}

    <h1 class="main-title">Your Charts</h1>
        <div class="chart-container">
            <div class="chart-box">
                <h3>Income (Earnings Only) vs. Spending</h3>
                <div id="income_spending"></div>
                <p class="chart-description">Add more entries so the graph shows more detail</p>
            </div>

            <div class="chart-box">
                <h3>Expense Breakdown</h3>
                <div id="expense_bar"></div>
            </div>

            <div class="chart-box">
                <h3 class="chart-section-title">Pie Breakdown</h3>

                <div class="pie-charts-grid">

                    <div class="pie-chart-wrapper">
                        <h3>Savings vs. Spending</h3>
                        <div id="overview_pie"></div>
                        <p class="chart-description">Ratio between your income and spendings</p>
                    </div>

                    <div class="pie-chart-wrapper">
                        <h3>Spending Breakdown</h3>
                        <div id="spending_pie"></div>
                        <p class="chart-description">Breakdown of all your spending</p>
                    </div>

                </div>
            </div>
        </div>

{% endblock %}

{% block scripts%}
    <script>
        fetch("/spending_income_data").then(response => response.json()).then(data=> {
            const income = {
                x: data.dates_income,
                y: data.income,
                type: "scatter",
                mode: "lines+markers",
                name: "Income",
                line: {
                    color: '#5fb878',
                    width: 3
                },
                marker: {
                    color: '#5fb878',
                    size: 8
                },
                text: data.income.map(val => `$${val}`),
                hovertemplate: '<b>%{text}</b><br>Date: %{x}<extra></extra>'
            };

            const spending = {
                x: data.dates_spending,
                y: data.spending,
                type: "scatter",
                mode: "lines+markers",
                name: "Spending",
                line: {
                    color:"#e87373",
                    width: 3
                },
                marker: {
                    color: "#e87373",
                    size: 8
                },
                text: data.spending.map(val => `$${val}`),  
                hovertemplate: '<b>%{text}</b><br>Date: %{x}<extra></extra>'
            };

            // Function to interpolate income at a given date
            function getIncomeAtDate(targetDate) {
                const targetTime = new Date(targetDate).getTime();
                
                // Find the two income points that bracket this date
                for (let i = 0; i < data.dates_income.length - 1; i++) {
                    const date1 = new Date(data.dates_income[i]).getTime();
                    const date2 = new Date(data.dates_income[i + 1]).getTime();
                    
                    if (targetTime >= date1 && targetTime <= date2) {
                        // Linear interpolation
                        const ratio = (targetTime - date1) / (date2 - date1);
                        const income1 = data.income[i];
                        const income2 = data.income[i + 1];
                        return income1 + ratio * (income2 - income1);
                    }
                }
                
                // If before first income point or after last, return null
                return null;
            }

            // Create warning markers
            const warningPoints = {
                x: [],
                y: [],
                type: "scatter",
                mode: "markers",
                name: "⚠️ Over Spent",
                marker: {
                    color: '#f4d03f',
                    size: 9,
                    symbol: 'circle',
                    line: {
                        color: '#f39c12',
                        width: 2
                    }
                },
                text: [],
                hovertemplate: '<b>⚠️ WARNING</b><br>Spending: %{text}<br>Date: %{x}<extra></extra>'
            };

            // Check each spending point against interpolated income
            data.spending.forEach((spend, i) => {
                const spendDate = data.dates_spending[i];
                const interpolatedIncome = getIncomeAtDate(spendDate);
                
                if (interpolatedIncome !== null && spend > interpolatedIncome) {
                    warningPoints.x.push(spendDate);
                    warningPoints.y.push(spend);
                    warningPoints.text.push(`$${spend}`);
                }
            });
            
            const layout = {
                autosize: true,
                margin: {t: 60, b: 60, l: 60, r: 40},
                xaxis: {title: "Dates"},
                yaxis: {title: "Cash ($)"}
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot("income_spending", [income, spending, warningPoints], layout, config);
        });


        fetch("/all_expense_data").then(response => response.json()).then(data=>{
            const earned = {
                x: data.expenses,
                y: data.total_earned,
                name: "Total Earned",
                type: "bar",
                marker: { color: "#5fb878" },
                text: data.total_earned.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "none",
                hovertemplate: '<b>Total Earnings</b><br> $%{y}<extra></extra>'
            };

            const deposits = {
                x: data.expenses,
                y: data.total_deposit,
                name: "Total Deposit",
                type: "bar",
                marker: { color: "#e8be3f" },
                text: data.total_deposit.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "none",
                hovertemplate: '<b>Total Deposited</b><br> $%{y}<extra></extra>'
            };

            const spending = {
                x: data.expenses,
                y: data.total_spent,
                name: "Total Spent",
                type: "bar",
                marker: { color: "#e87373" },
                text: data.total_spent.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "y+name",
                hovertemplate: '<b>Total Spent</b><br> $%{y}<extra></extra>'
            };

            const savings = {
                x: data.expenses,
                y: data.total_saved,
                name: "Total Saved",
                type: "bar",
                marker: { color: "#3AAFA9" },
                text: data.total_saved.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "y+name",
                hovertemplate: '<b>Total Savings</b><br> $%{y}<extra></extra>'
            };

            const layout = {
                barmode: "group",
                autosize: true,
                margin: {t: 60, b: 60, l: 60, r: 40}
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot("expense_bar", [earned, spending, deposits, savings], layout, config);
        });

        fetch("/save_spend_data").then(response => response.json()).then(data => {
            const values = [{
                type: "pie",
                values: data.all_data,
                labels: data.data_labels,
                marker: {
                    colors: [ '#e87373', '#5fb878']
                },
                textinfo: "label+percent",
                textposition: "outside",
                automargin: true,
                textfont: {
                    size: 12
                },
                hovertemplate: '<b>%{label}</b><br>$%{value}<br>%{percent}<extra></extra>'
            }];
            
            const layout = {
                autosize: true,
                height: 400,
                margin: {t: 70, b: 40, l: 20, r: 20},
                showlegend: false,
                hoverlabel: {
                    font: {
                        color: "#1d2129"
                    }
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            Plotly.newPlot('overview_pie', values, layout, config);
        });

        fetch("/all_spend_data").then(response => response.json()).then(data => {
            const values = [{
                type: "pie",
                values: data.total,
                labels: data.expense_name,
                textinfo: "label+percent",
                textposition: "outside",
                automargin: true,
                textfont: {
                    size: 12
                },
                hovertemplate: '<b>%{label}</b><br>$%{value}<br>%{percent}<extra></extra>'
            }];
            
            const layout = {
                autosize: true,
                height: 400,
                margin: {t: 70, b: 40, l: 20, r: 20},
                showlegend: false,
                hoverlabel: {
                    font: {
                        color: "#1d2129"
                    }
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            Plotly.newPlot('spending_pie', values, layout, config);
        });
    </script>

{% endblock %}