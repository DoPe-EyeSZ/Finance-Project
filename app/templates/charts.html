{% extends "budget_base.html" %}
{% block title%} Charts {% endblock%}

{% block content %}


    <div class="chart-container">
        <div id="chart"></div>
        <p class="chart-description">The more entries you add, the more accurate and visually detailed your spending trends will become. Consistent tracking provides better financial insights over time.</p>
    </div>

    <div class="chart-container">
        <div id="expense_bar"></div>
    </div>

    <div class="chart-container">
        <h3 class="chart-section-title">Financial Breakdown</h3>
        <div class="pie-charts-grid">
            <div class="pie-chart-wrapper">
                <div id="overview_pie"></div>
                <p class="chart-description">Distribution of total income between spending and savings</p>
            </div>
            <div class="pie-chart-wrapper">
                <div id="spending_pie"></div>
                <p class="chart-description">Breakdown of spending across all expense categories</p>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts%}
    <script>
        fetch("/spending_income_data").then(response => response.json()).then(data=> {
            const income = {
                x: data.dates_income,
                y: data.income,
                type: "scatter",
                mode: "lines+markers",
                name: "Income",
                line: {
                    color: '#5fb878',
                    width: 3
                },
                marker: {
                    color: '#5fb878',
                    size: 8
                },
                text: data.income.map(val => `$${val}`),
                hovertemplate: '<b>%{text}</b><br>Date: %{x}<extra></extra>'
            };

            const spending = {
                x: data.dates_spending,
                y: data.spending,
                type: "scatter",
                mode: "lines+markers",
                name: "Spending",
                line: {
                    color:"#e87373",
                    width: 3
                },
                marker: {
                    color: "#e87373",
                    size: 8
                },
                text: data.spending.map(val => `$${val}`),  
                hovertemplate: '<b>%{text}</b><br>Date: %{x}<extra></extra>'
            };
            
            const layout = {
                title: "Income/Spending Over Time",
                xaxis: {title: "Dates"},
                yaxis: {title: "Cash ($)"}
            };

            Plotly.newPlot("chart", [income, spending], layout, {displayModeBar: false});
        });

        fetch("/all_expense_data").then(response => response.json()).then(data=>{
            const earned = {
                x: data.expenses,
                y: data.total_earned,
                name: "Total Earnings",
                type: "bar",
                marker: { color: "#5fb878" },
                text: data.total_earned.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "none",
                hovertemplate: '<b>Total Earnings</b><br> $%{y}<extra></extra>'
            };

            const spending = {
                x: data.expenses,
                y: data.total_spent,
                name: "Total Spending",
                type: "bar",
                marker: { color: "#e87373" },
                text: data.total_spent.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "y+name",
                hovertemplate: '<b>Total Spent</b><br> $%{y}<extra></extra>'
            };

            const savings = {
                x: data.expenses,
                y: data.total_saved,
                name: "Total Savings",
                type: "bar",
                marker: { color: "#3AAFA9" },
                text: data.total_saved.map(val => `$${val}`),
                textposition: "auto",
                hoverinfo: "y+name",
                hovertemplate: '<b>Total Savings</b><br> $%{y}<extra></extra>'
            };

            const layout = {
                barmode: "group",
                title: "Individual Expense Overview"
            };

            Plotly.newPlot("expense_bar", [earned, spending, savings], layout, {displayModeBar: false})
        });

        fetch("/save_spend_data").then(response => response.json()).then(data => {
            const values = [{
                type: "pie",
                values: data.all_data,
                labels: data.data_labels,
                marker: {
                    colors: [ '#e87373', '#5fb878']
                },
                textinfo: "label+percent",
                textposition: "outside",
                automargin: true,
                textfont: {
                    size: 14
                },
                hovertemplate: '<b>%{label}</b><br>$%{value}<br>%{percent}<extra></extra>'
            }];
            
            const layout = {
                title: "Spending vs. Savings",
                height: 400,
                width: 500,
                margin: {t: 60, b: 40, l: 40, r: 40},
                showlegend: false,
                hoverlabel: {
                    font: {
                        color: "#1d2129"
                    }
                }
            };
            
            Plotly.newPlot('overview_pie', values, layout, {displayModeBar: false});
        });

        fetch("/all_spend_data").then(response => response.json()).then(data => {
            const values = [{
                type: "pie",
                values: data.total,
                labels: data.expense_name,
                textinfo: "label+percent",
                textposition: "outside",
                automargin: true,
                textfont: {
                    size: 14
                },
                hovertemplate: '<b>%{label}</b><br>$%{value}<br>%{percent}<extra></extra>'
            }];
            
            const layout = {
                title: "Spending Breakdown",
                height: 400,
                width: 500,
                margin: {t: 60, b: 40, l: 40, r: 40},
                showlegend: false,
                hoverlabel: {
                    font: {
                        color: "#1d2129"
                    }
                }
            };
            
            Plotly.newPlot('spending_pie', values, layout, {displayModeBar: false});
        });
    </script>

{% endblock %}