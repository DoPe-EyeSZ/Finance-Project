{% extends "budget_base.html"%}
{% block title %}Statistics{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<div class="expense-container">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for msg in messages %}
                <div class="flash-message">{{msg}}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h1 class="main-title">Hello {{user.name}}</h1>

    {% if active_expenses or inactive_expenses %}
    <div class="lifetime-stats-section">
        <h2 class="lifetime-stats-title">Lifetime Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card-main">
                <div class="stat-label-main">Total Balance</div>
                <div class="stat-value-main balance">${{lifetime_stats["Balance"]}}</div>
            </div>
            <div class="stat-card-main">
                <div class="stat-label-main">Total Earnings</div>
                <div class="stat-value-main earnings">${{lifetime_stats["Earnings"]}}</div>
            </div>
            <div class="stat-card-main">
                <div class="stat-label-main">Total Transferred</div>
                <div class="stat-value-main">${{lifetime_stats["Transferred"]}}</div>
            </div>
            <div class="stat-card-main">
                <div class="stat-label-main">Total Spent</div>
                <div class="stat-value-main spent">${{lifetime_stats["Spendings"]}}</div>
            </div>
            <div class="stat-card-main">
                <div class="stat-label-main">Total Savings</div>
                <div class="stat-value-main savings">${{lifetime_stats["Savings"]}}</div>
            </div>
            <div class="stat-card-main">
                <div class="stat-label-main">Total Credit Balance</div>
                <div class="stat-value-main">${{lifetime_stats["Credit_Balance"]}}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if active_expenses %}
    <div class="expenses-section">
        <h1 class="section-title-large">Active Expenses</h1>
    {% for expense_id in active_expenses %}
    <div class="expense-block">
        <h3 class="expense-name-small">{{active_expenses[expense_id]["name"]}}</h3>
        {% set earned = active_expenses[expense_id]["earning"]%}
        {% set spent = active_expenses[expense_id]["spending"]%}
        {% set saved = active_expenses[expense_id]["saving"]%}
        {% set balance = active_expenses[expense_id]["balance"]%}
        {% set transferred = active_expenses[expense_id]["transferred"]%}
        {% set credit_balance = active_expenses[expense_id]["credit_balance"]%}

        <table class="expense-table stats-table">
            <thead>
                <tr>
                    <th>Total Balance</th>
                    <th>Earned</th>
                    <th>Transferred</th>
                    <th>Spent</th>
                    <th>Credit Balance</th>
                    <th>Remaining</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="balance-cell">${{balance}}</td>
                    <td class="earnings-cell">${{earned}}</td>
                    <td>${{transferred}}</td>
                    <td class="spent-cell">${{spent}}</td>
                    <td>${{credit_balance}}</td>
                    <td class="savings-cell">${{saved}}</td>
                </tr>
            </tbody>
        </table>

        {% if earned == 0 %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" style="width: 100%">
                N/A
            </div>
        </div>
        {% elif spent >= earned %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 100%">
                Spent: 100%
            </div>
        </div>
        {% elif saved == 0 %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%">
                Saved: 0%
            </div>
        </div>
        {% else %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            {% if active_expenses[expense_id]['spending_percent'] > 10 %}
            <div class="progress-bar bg-danger" role="progressbar" style="width: {{active_expenses[expense_id]['spending_percent']}}%">
                Spent: {{active_expenses[expense_id]['spending_percent']}}%
            </div>
            {% else %}
            <div class="progress-bar bg-danger" role="progressbar" style="width: {{active_expenses[expense_id]['spending_percent']}}%"></div>
            {% endif %}
            
            {% if active_expenses[expense_id]['saving_percent'] > 10 %}
            <div class="progress-bar bg-success" role="progressbar" style="width: {{active_expenses[expense_id]['saving_percent']}}%">
                Saved: {{active_expenses[expense_id]['saving_percent']}}%
            </div>
            {% else %}
            <div class="progress-bar bg-success" role="progressbar" style="width: {{active_expenses[expense_id]['saving_percent']}}%"></div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    </div>
    {% endif %}

    {% if inactive_expenses %}
    <hr class="section-divider">
    <div class="expenses-section">
        <h1 class="section-title-large">Archived Expenses</h1>
    {% for expense_id in inactive_expenses %}
    <div class="expense-block">
        <h3 class="expense-name-small">{{inactive_expenses[expense_id]["name"]}}</h3>
        {% set earned = inactive_expenses[expense_id]["earning"]%}
        {% set spent = inactive_expenses[expense_id]["spending"]%}
        {% set saved = inactive_expenses[expense_id]["saving"]%}
        {% set balance = inactive_expenses[expense_id]["balance"]%}
        {% set transferred = inactive_expenses[expense_id]["transferred"]%}
        {% set credit_balance = inactive_expenses[expense_id]["credit_balance"]%}

        <table class="expense-table stats-table">
            <thead>
                <tr>
                    <th>Total Balance</th>
                    <th>Earned</th>
                    <th>Transferred</th>
                    <th>Spent</th>
                    <th>Credit Balance</th>
                    <th>Remaining</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="balance-cell">${{balance}}</td>
                    <td class="earnings-cell">${{earned}}</td>
                    <td>${{transferred}}</td>
                    <td class="spent-cell">${{spent}}</td>
                    <td>${{credit_balance}}</td>
                    <td class="savings-cell">${{saved}}</td>
                </tr>
            </tbody>
        </table>

        {% if earned == 0 %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" role="progressbar" style="width: 100%">
                N/A
            </div>
        </div>
        {% elif spent >= earned %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 100%">
                Spent: 100%
            </div>
        </div>
        {% elif saved == 0 %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%">
                Saved: 0%
            </div>
        </div>
        {% else %}
        <div class="progress" style="height: 40px; font-size: 1.1em; margin-top: 20px;">
            {% if inactive_expenses[expense_id]['spending_percent'] > 10 %}
            <div class="progress-bar bg-danger" role="progressbar" style="width: {{inactive_expenses[expense_id]['spending_percent']}}%">
                Spent: {{inactive_expenses[expense_id]['spending_percent']}}%
            </div>
            {% else %}
            <div class="progress-bar bg-danger" role="progressbar" style="width: {{inactive_expenses[expense_id]['spending_percent']}}%"></div>
            {% endif %}
            
            {% if inactive_expenses[expense_id]['saving_percent'] > 10 %}
            <div class="progress-bar bg-success" role="progressbar" style="width: {{inactive_expenses[expense_id]['saving_percent']}}%">
                Saved: {{inactive_expenses[expense_id]['saving_percent']}}%
            </div>
            {% else %}
            <div class="progress-bar bg-success" role="progressbar" style="width: {{inactive_expenses[expense_id]['saving_percent']}}%"></div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    </div>
    {% endif %}

    {% if spending %}
    <hr class="section-divider">
    <h1 class="section-title">Spending Log</h1>
    <table class="expense-table">
        <thead>
            <tr>
                <th>Expense</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Reasoning</th>
            </tr>
        </thead>
        <tbody>
            {% for spent in spending %}
            <tr>
                <td>{{spent.expense_name}}</td>
                <td>{{spent.date}}</td>
                <td class="spent-cell">${{spent.amount}}</td>
                <td>{{spent.reasoning}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if not active_expense and not inactive_expense %}
    <div class="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <h2 class="empty-title">No Expenses Yet</h2>
        <p class="empty-text">You haven't created any expense categories yet. Create your first expense to start tracking your budget!</p>
        <a href="/expenses" class="empty-cta">Create Your First Expense</a>
    </div>
    {% endif %}
</div>

{% endblock %}