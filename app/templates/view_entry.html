{% extends "budget_base.html" %}
{% block title%} View Entry {% endblock%}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<div class="expense-container">

    <div class="date-editor">
        <h1 class="main-title">
            <form action="/update_date/{{entry.id}}" method="POST" class="inline-date-form">
                <span>DATE:</span>
                <input type="date" value="{{entry.date}}" name="new_date" class="date-input-title">
                <button type="submit" class="btn btn-primary btn-sm">Save</button>
            </form>
        </h1>
    </div>


    <div class="entry-overview">
        <div class="entry-stat income">
            <div class="entry-stat-label"> Income</div>
            <div class="entry-stat-value">${{ entry.income }}</div>
        </div>
        <div class="entry-stat spent">
            <div class="entry-stat-label">Total Spent</div>
            <div class="entry-stat-value">${{ total_spent }}</div>
        </div>
        <div class="entry-stat {% if entry.income - total_spent >= 0 %}income{% else %}spent{% endif %}">
            <div class="entry-stat-label">Net Earnings</div>
            <div class="entry-stat-value">${{net_earnings}}</div>
        </div>
    </div>

        <div class="function-sections">
            <div class="form-section">
                <h2 class="form-title">Add Income</h2>
                <p class="function-helper-text"><span class="tip-star">★</span> Automatically distributes income</p>
                <form action="/add_income/{{entry.id}}" method="POST" class="inline-form">
                    <div class="input-wrapper">
                        <input type="number" step="0.01" name="income" placeholder="Enter income" required>
                    </div>
                    <button type="submit" class="form-btn">Submit</button>
                </form>
            </div>

            <div class="form-section">
                <h2 class="form-title">Deposit</h2>
                    <p class="function-helper-text"><span class="tip-star">★</span> Add funds directly to a specific expense category</p>
                    <form action="/entry_deposit" method="POST" class="inline-form">
                        <select name="snap_id" required>
                            <option value="">Select Expense</option>
                            {% for snap in snapshots %}
                                <option value="{{snap.id}}">{{snap.expense_name}}</option>
                            {% endfor %}
                        </select>

                        <div class="input-wrapper">
                            <input type="number" step="0.01" name="amount" placeholder="Amount"  required>
                        </div>

                        <button type="submit" class="form-btn">Deposit</button>
                </form>
            </div>
            
        
    </div>
    

    <h1 class="section-title">Expense Breakdown</h1>
    <table class="expense-table">
        <thead>
            <tr>
                <th>Expense</th>
                <th>Allocated</th>
                <th>Leftover Cash</th>
                <th>Add Spending</th>
                <th>Credit Balance</th>
                <th>Saved</th>
            </tr>
        </thead>
        <tbody>
            {% for snapshot in snapshots %}
            <tr>
                <td>{{snapshot.expense_name}}</td>
                <td class="earnings-cell">${{snapshot.expense_earnings}}</td>
                <td class="balance-cell">${{est_balance[snapshot]}}</td>
                <td>
                    <form action="/add_spending/{{snapshot.id}}" method="POST" class="spending-form">
                        <div class="spending-inputs">
                            <div class="input-wrapper-small">
                                <span class="currency-symbol-small">$</span>
                                <input type="number" step="0.01" placeholder="Spent: {{snapshot.total_spending}}" name="spending" required>
                            </div>
                            <input type="text" placeholder="Add Note" name="reasoning" class="note-input">
                        </div>
                        <div class="spending-buttons">
                            <button type="submit" class="btn btn-success btn-sm">Debit</button>
                            <button type="submit" class="btn btn-primary btn-sm" formaction="/add_credit/{{snapshot.id}}">Credit</button>
                        </div>
                    </form>
                </td>
                <td class="spent-cell">${{snapshot.credit_balance}}</td>
                <td class="savings-cell">${{snapshot.get_savings()}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if spending %}
    <h1 class="section-title">Spending Log</h1>
    <table class="expense-table">
        <thead>
            <tr>
                <th>Expense</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Reasoning</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for spent in spending %}
            <tr class="log-row {% if spent.credit_status %}credit-row{% endif %}" data-row-id="spending-{{spent.id}}">
                <td>{{spent.expense_name}}</td>
                
                <!-- Date Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text">{{spent.date}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/update_transaction_date/{{spent.id}}" method="POST" class="inline-edit-form">
                            <input type="hidden" name="source" value="entry">
                            <input type="date" value="{{spent.date}}" name="new_date" class="date-input-table">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Amount Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text spent-cell">${{spent.amount}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/edit_transaction_amount/{{spent.id}}" method="POST" class="inline-edit-form">
                            <div class="input-wrapper-small">
                                <span class="currency-symbol-small">$</span>
                                <input type="number" min="0" placeholder="{{spent.amount}}" name="amount" step="0.01" required>
                            </div>
                            <button class="btn btn-success btn-sm" type="submit">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Reasoning Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text">{{spent.reasoning}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/edit_transaction_reasoning/{{spent.id}}" method="POST" class="inline-edit-form">
                            <input type="hidden" name="source" value="entry">
                            <input type="text" placeholder="{{spent.reasoning}}" name="reasoning" class="note-input" required>
                            <button class="btn btn-success btn-sm" type="submit">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Actions -->
                <td>
                    <button class="btn btn-info btn-dark btn-sm edit-toggle-btn" onclick="toggleEdit('spending-{{spent.id}}')">Edit</button>
                    <form action="/delete_transaction/{{spent.id}}" method="POST" style="display: inline;">
                        <input type="hidden" name="source" value="entry">
                        <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                        {% if spent.credit_status %}
                        <button class="btn btn-primary btn-sm" type="submit" formaction="/pay_credit/{{spent.id}}">Pay Credit</button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}



    {% if deposits %}
    <h1 class="section-title">Entry's Deposit Log</h1>
    <table class="expense-table">
        <thead>
            <tr>
                <th>Expense</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Reasoning</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for deposit in deposits %}
            <tr class="log-row" data-row-id="deposit-{{deposit.id}}">
                <td>{{deposit.expense_name}}</td>
                
                <!-- Date Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text">{{deposit.date}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/update_transaction_date/{{deposit.id}}" method="POST" class="inline-edit-form">
                            <input type="hidden" name="source" value="entry">
                            <input type="date" value="{{deposit.date}}" name="new_date" class="date-input-table">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Amount Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text">${{deposit.amount}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/edit_transaction_amount/{{deposit.id}}" method="POST" class="inline-edit-form">
                            <div class="input-wrapper-small">
                                <span class="currency-symbol-small">$</span>
                                <input type="number" min="0" placeholder="{{deposit.amount}}" name="amount" step="0.01" required>
                            </div>
                            <button class="btn btn-success btn-sm" type="submit">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Reasoning Display/Edit -->
                <td>
                    <div class="display-mode">
                        <span class="display-text">{{deposit.reasoning}}</span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <form action="/edit_transaction_reasoning/{{deposit.id}}" method="POST" class="inline-edit-form">
                            <input type="hidden" name="source" value="entry">
                            <input type="text" placeholder="{{deposit.reasoning}}" name="reasoning" class="note-input" required>
                            <button class="btn btn-success btn-sm" type="submit">Save</button>
                        </form>
                    </div>
                </td>
                
                <!-- Actions -->
                <td>
                    <button class="btn btn-dark btn-info btn-sm edit-toggle-btn" onclick="toggleEdit('deposit-{{deposit.id}}')">Edit</button>
                    <form action="/delete_transaction/{{deposit.id}}" method="POST" style="display: inline;">
                        <input type="hidden" name="source" value="entry">
                        <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                        {% if deposit.credit_status %}
                        <button class="btn btn-primary btn-sm" type="submit" formaction="/pay_credit/{{deposit.id}}">Pay Credit</button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>


{% endblock %}

{% block scripts%}
<script>
function toggleEdit(rowId) {
    const row = document.querySelector(`[data-row-id="${rowId}"]`);
    const displayModes = row.querySelectorAll('.display-mode');
    const editModes = row.querySelectorAll('.edit-mode');
    const editBtn = row.querySelector('.edit-toggle-btn');
    
    // Check current state
    const isEditing = editModes[0].style.display !== 'none';
    
    if (isEditing) {
        // Switch to display mode
        displayModes.forEach(el => el.style.display = 'block');
        editModes.forEach(el => el.style.display = 'none');
        editBtn.textContent = 'Edit';
        editBtn.classList.remove('btn-secondary');
        editBtn.classList.add('btn-dark');
    } else {
        // Switch to edit mode
        displayModes.forEach(el => el.style.display = 'none');
        editModes.forEach(el => el.style.display = 'block');
        editBtn.textContent = 'Cancel';
        editBtn.classList.remove('btn-dark');
        editBtn.classList.add('btn-secondary');
    }
}
</script>
{% endblock %}